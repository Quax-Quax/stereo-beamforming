<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ãƒ†ãƒ¬ã‚ªãƒã‚¤ã‚¯æŒ‡å‘æ€§å¼·åŒ– - ãƒ“ãƒ¼ãƒ ãƒ•ã‚©ãƒ¼ãƒŸãƒ³ã‚°</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --border-color: #e0e0e0;
            --accent-blue: #2563eb;
            --accent-blue-hover: #1d4ed8;
            --accent-blue-light: #dbeafe;
            --meter-green: #10b981;
            --button-bg: #ffffff;
            --button-border: #e0e0e0;
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #0f172a;
                --bg-secondary: #1e293b;
                --text-primary: #f1f5f9;
                --text-secondary: #94a3b8;
                --border-color: #334155;
                --accent-blue: #3b82f6;
                --accent-blue-hover: #2563eb;
                --accent-blue-light: #1e3a8a;
                --meter-green: #10b981;
                --button-bg: #1e293b;
                --button-border: #334155;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-secondary);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: var(--bg-primary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: var(--text-primary);
            margin-bottom: 10px;
            font-size: 24px;
        }

        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-size: 14px;
        }

        .section {
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ãƒœã‚¿ãƒ³ç¾¤ */
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%;
        }

        button {
            padding: 12px 16px;
            border: 1px solid var(--button-border);
            background: var(--button-bg);
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--text-primary);
        }

        button:hover {
            border-color: var(--accent-blue);
            background: var(--accent-blue-light);
        }

        button.active {
            background: var(--accent-blue);
            color: white;
            border-color: var(--accent-blue);
        }

        .control-button {
            padding: 12px 20px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .control-button:hover {
            background: var(--accent-blue-hover);
        }

        .control-button:disabled {
            background: var(--text-secondary);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .control-button.stop {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .control-button.stop:hover {
            background: var(--border-color);
        }

        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 12px;
        }

        .slider-label {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            min-width: 100px;
        }

        input[type="range"] {
            flex: 1;
            height: 4px;
            border-radius: 2px;
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent-blue);
            cursor: pointer;
            border: none;
        }

        .slider-value {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 50px;
            text-align: right;
        }

        select {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
            background: var(--button-bg);
            color: var(--text-primary);
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        select:hover {
            border-color: var(--accent-blue);
        }

        select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 4px;
            font-size: 13px;
            margin-bottom: 15px;
        }

        .status-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .status-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            margin-right: 8px;
        }

        .status-indicator.active {
            background: var(--meter-green);
        }

        /* ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
        .meter-container {
            margin-bottom: 12px;
        }

        .meter-label {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
        }

        .meter-bar {
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
        }

        .meter-fill {
            height: 100%;
            background: var(--meter-green);
            width: 0%;
            transition: width 0.1s ease;
        }

        /* æƒ…å ±ãƒ‘ãƒãƒ« */
        .info-box {
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent-blue);
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 15px;
        }

        .info-box h4 {
            font-size: 13px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .info-box ul {
            margin-left: 20px;
            line-height: 1.6;
        }

        .info-box p {
            line-height: 1.6;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 600px) {
            .container {
                padding: 25px;
            }

            h1 {
                font-size: 20px;
            }

            .button-group {
                grid-template-columns: 1fr;
            }
        }

        .error {
            background: var(--bg-secondary);
            border-left: 3px solid #ef4444;
            padding: 12px 16px;
            border-radius: 4px;
            font-size: 13px;
            color: #ef4444;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ™ï¸ ã‚¹ãƒ†ãƒ¬ã‚ªãƒã‚¤ã‚¯æŒ‡å‘æ€§å¼·åŒ–</h1>
        <p class="subtitle">ãƒ“ãƒ¼ãƒ ãƒ•ã‚©ãƒ¼ãƒŸãƒ³ã‚°ã§å‘¨å›²ã®éŸ³å£°ã‚’æŠ‘åˆ¶</p>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div class="section">
            <div class="status">
                <span class="status-label">
                    <span class="status-indicator" id="statusIndicator"></span>
                    çŠ¶æ…‹
                </span>
                <span class="status-value" id="statusText">å¾…æ©Ÿä¸­</span>
            </div>
            <div id="errorBox" class="error" style="display: none;"></div>
        </div>

        <!-- ãƒã‚¤ã‚¯åˆ¶å¾¡ -->
        <div class="section">
            <div class="section-title">ğŸ“± ãƒã‚¤ã‚¯åˆ¶å¾¡</div>
            <button class="control-button" id="startBtn">ãƒã‚¤ã‚¯ã‚’é–‹å§‹</button>
            <button class="control-button stop" id="stopBtn" disabled style="margin-top: 10px;">åœæ­¢</button>
        </div>

        <!-- å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹é¸æŠ -->
        <div class="section">
            <div class="section-title">ğŸ”Š å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹</div>
            <div class="slider-container">
                <label class="slider-label">ãƒ‡ãƒã‚¤ã‚¹</label>
                <select id="outputDeviceSelect"></select>
            </div>
            <div id="sinkIdStatus" style="font-size: 12px; color: #999; margin-top: 8px;"></div>
        </div>

        <!-- ãƒã‚¤ã‚¯é–“éš”èª¿æ•´ -->
        <div class="section">
            <div class="section-title">âš™ï¸ ãƒã‚¤ã‚¯é–“éš”ï¼ˆåˆæœŸå€¤: 20cmï¼‰</div>
            <div class="slider-container">
                <label class="slider-label">é–“éš” (cm)</label>
                <input type="range" id="micDistanceSlider" min="5" max="50" value="20" step="1">
                <span class="slider-value" id="micDistanceValue">20 cm</span>
            </div>
            <div class="info-box">
                <h4>ğŸ’¡ ãƒ’ãƒ³ãƒˆ</h4>
                <ul>
                    <li>PCã®ãƒã‚¤ã‚¯é–“éš”ã«åˆã‚ã›ã¦èª¿æ•´ã—ã¦ãã ã•ã„</li>
                    <li>å€¤ã‚’å¤§ããã™ã‚‹ã»ã©æŒ‡å‘æ€§ãŒå¼·ããªã‚Šã¾ã™</li>
                </ul>
            </div>
        </div>

        <!-- å‡¦ç†æ–¹æ³•é¸æŠ -->
        <div class="section">
            <div class="section-title">ğŸ¯ å‡¦ç†æ–¹æ³•ã‚’é¸æŠ</div>
            <div class="button-group">
                <button id="methodPassthrough" class="method-btn active">
                    ãƒ‘ã‚¹ã‚¹ãƒ«ãƒ¼<br><small style="font-size: 11px; opacity: 0.7;">æ¯”è¼ƒç”¨</small>
                </button>
                <button id="methodMidside" class="method-btn">
                    Mid/Side<br><small style="font-size: 11px; opacity: 0.7;">Sideæ¸›è¡°</small>
                </button>
                <button id="methodParacardioid" class="method-btn">
                    ãƒ‘ãƒ©ã‚«ãƒ¼ãƒ‡ã‚£ã‚ªã‚¤ãƒ‰<br><small style="font-size: 11px; opacity: 0.7;">æŒ‡å‘æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³</small>
                </button>
                <button id="methodTDOA" class="method-btn">
                    TDOA<br><small style="font-size: 11px; opacity: 0.7;">æ™‚é–“å·®é…å»¶</small>
                </button>
                <button id="methodFrequency" class="method-btn" style="grid-column: 1 / 2;">
                    å‘¨æ³¢æ•°ä¾å­˜<br><small style="font-size: 11px; opacity: 0.7;">å¸¯åŸŸåˆ¥å‡¦ç†</small>
                </button>
            </div>
        </div>

        <!-- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ -->
        <div class="section" id="parameterSection" style="display: none;">
            <div class="section-title">ğŸ”§ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´</div>
            <div id="parameterControls"></div>
        </div>

        <!-- å…¥å‡ºåŠ›ãƒ¡ãƒ¼ã‚¿ãƒ¼ -->
        <div class="section">
            <div class="section-title">ğŸ“Š ãƒ¬ãƒ™ãƒ«ãƒ¡ãƒ¼ã‚¿ãƒ¼</div>
            <div class="meter-container">
                <div class="meter-label">
                    <span>å…¥åŠ›ãƒ¬ãƒ™ãƒ«</span>
                    <span id="inputLevel">0 dB</span>
                </div>
                <div class="meter-bar">
                    <div class="meter-fill" id="inputMeter"></div>
                </div>
            </div>
            <div class="meter-container">
                <div class="meter-label">
                    <span>å‡ºåŠ›ãƒ¬ãƒ™ãƒ«</span>
                    <span id="outputLevel">0 dB</span>
                </div>
                <div class="meter-bar">
                    <div class="meter-fill" id="outputMeter"></div>
                </div>
            </div>
        </div>

        <!-- èª¬æ˜ -->
        <div class="section">
            <div class="section-title">â„¹ï¸ å‡¦ç†æ–¹æ³•ã®èª¬æ˜</div>
            <div class="info-box">
                <h4>Mid/Side</h4>
                <p>L+Rï¼ˆä¸­å¤®ï¼‰ã¨ L-Rï¼ˆå´é¢ï¼‰ã«åˆ†è§£ã—ã€å´é¢æˆåˆ†ã‚’æ¸›è¡°ã•ã›ã‚‹ã“ã¨ã§æŒ‡å‘æ€§ã‚’å¼·åŒ–ã—ã¾ã™ã€‚</p>
                
                <h4>ãƒ‘ãƒ©ã‚«ãƒ¼ãƒ‡ã‚£ã‚ªã‚¤ãƒ‰</h4>
                <p>è¤‡æ•°ã®æŒ‡å‘æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå…¨æŒ‡å‘æ€§ãƒ»åŒæŒ‡å‘æ€§ï¼‰ã‚’åˆæˆã—ã€æ­£é¢æ–¹å‘ã®æ„Ÿåº¦ã‚’ä¸Šã’ã¾ã™ã€‚</p>
                
                <h4>TDOA</h4>
                <p>ãƒãƒ£ãƒ³ãƒãƒ«é–“ã®æ™‚é–“å·®ã‚’åˆ©ç”¨ã—ã€ç‰¹å®šã®æ–¹å‘ã‹ã‚‰æ¥ãŸéŸ³ã‚’å¼·èª¿ã—ã¾ã™ã€‚</p>
                
                <h4>å‘¨æ³¢æ•°ä¾å­˜</h4>
                <p>ä½å‘¨æ³¢ã¯å…¨æŒ‡å‘æ€§ã€é«˜å‘¨æ³¢ã¯ã‚«ãƒ¼ãƒ‡ã‚£ã‚ªã‚¤ãƒ‰ã‚’é©ç”¨ã—ã€å¸¯åŸŸã”ã¨ã«æœ€é©ãªå‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        /**
         * AudioWorkletãƒ—ãƒ­ã‚»ãƒƒã‚µã‚³ãƒ¼ãƒ‰ï¼ˆåŸ‹ã‚è¾¼ã¿ç‰ˆï¼‰
         */
        const processorCode = `
class BeamformingProcessor extends AudioWorkletProcessor {
  constructor(options) {
    super();
    this.micDistance = 0.2;
    this.sampleRate = sampleRate;
    this.currentMethod = 'passthrough';
    this.midSideStrength = 0.7;
    this.paracardioidStrength = 0.8;
    this.tdoaDelay = 0;
    this.frequencyBands = 4;
    this.prevLeftSample = 0;
    this.prevRightSample = 0;
    
    this.port.onmessage = (event) => {
      const { command, value } = event.data;
      if (command === 'setMethod') {
        this.currentMethod = value;
      } else if (command === 'setMicDistance') {
        this.micDistance = value;
        this.updateTDOADelay();
      } else if (command === 'setMidSideStrength') {
        this.midSideStrength = value;
      } else if (command === 'setParacardioidStrength') {
        this.paracardioidStrength = value;
      }
    };
    this.updateTDOADelay();
  }
  
  updateTDOADelay() {
    const speedOfSound = 343;
    const delayTime = this.micDistance / speedOfSound;
    this.tdoaDelay = Math.round(delayTime * this.sampleRate);
  }
  
  processMidSide(left, right) {
    const mid = (left + right) / 2;
    const side = (left - right) / 2;
    const reducedSide = side * (1 - this.midSideStrength);
    const outLeft = (mid + reducedSide);
    const outRight = (mid - reducedSide);
    return [outLeft, outRight];
  }
  
  processParacardioid(left, right) {
    const omni = (left + right) / 2;
    const figure8 = (left - right) / 2;
    const cardioid = omni + figure8 * this.paracardioidStrength;
    return [cardioid, cardioid];
  }
  
  processTDOA(left, right) {
    let delayedRight;
    if (this.tdoaDelay > 0) {
      delayedRight = this.prevRightSample;
    } else {
      delayedRight = right;
    }
    const output = (left + delayedRight) / 2;
    this.prevLeftSample = left;
    this.prevRightSample = right;
    return [output, output];
  }
  
  processFrequencyDependent(left, right) {
    const midSideOut = this.processMidSide(left, right);
    const paraOut = this.processParacardioid(left, right);
    const weight = 0.4;
    const outLeft = midSideOut[0] * (1 - weight) + paraOut[0] * weight;
    const outRight = midSideOut[1] * (1 - weight) + paraOut[1] * weight;
    return [outLeft, outRight];
  }
  
  process(inputs, outputs, parameters) {
    const input = inputs[0];
    const output = outputs[0];
    
    // ã‚¹ãƒ†ãƒ¬ã‚ªå…¥åŠ›ãƒãƒ£ãƒ³ãƒãƒ«å–å¾—
    const leftChannel = input[0];
    const rightChannel = input.length > 1 ? input[1] : input[0];
    
    // ã‚¹ãƒ†ãƒ¬ã‚ªå‡ºåŠ›ãƒãƒ£ãƒ³ãƒãƒ«
    const outLeftChannel = output[0];
    const outRightChannel = output.length > 1 ? output[1] : output[0];
    
    if (!leftChannel || !rightChannel || !outLeftChannel) {
      return true;
    }
    
    for (let i = 0; i < leftChannel.length; i++) {
      let processed;
      switch (this.currentMethod) {
        case 'midside':
          processed = this.processMidSide(leftChannel[i], rightChannel[i]);
          break;
        case 'paracardioid':
          processed = this.processParacardioid(leftChannel[i], rightChannel[i]);
          break;
        case 'tdoa':
          processed = this.processTDOA(leftChannel[i], rightChannel[i]);
          break;
        case 'frequency':
          processed = this.processFrequencyDependent(leftChannel[i], rightChannel[i]);
          break;
        case 'passthrough':
        default:
          processed = [(leftChannel[i] + rightChannel[i]) / 2, 0];
          break;
      }
      // ãƒ¢ãƒãƒ©ãƒ«å‡ºåŠ›ã‚’ä¸¡ãƒãƒ£ãƒ³ãƒãƒ«ã«å‡ºåŠ›
      const outputSample = Math.max(-1, Math.min(1, processed[0]));
      outLeftChannel[i] = outputSample;
      outRightChannel[i] = outputSample;
    }
    return true;
  }
}
registerProcessor('beamforming-processor', BeamformingProcessor);
        `;

        /**
         * ã‚¹ãƒ†ãƒ¬ã‚ªãƒã‚¤ã‚¯æŒ‡å‘æ€§å¼·åŒ–ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
         */

        let audioContext = null;
        let mediaStream = null;
        let processor = null;
        let sourceNode = null;
        let analyzerInput = null;
        let analyzerOutput = null;

        const UI = {
            startBtn: document.getElementById('startBtn'),
            stopBtn: document.getElementById('stopBtn'),
            statusText: document.getElementById('statusText'),
            statusIndicator: document.getElementById('statusIndicator'),
            errorBox: document.getElementById('errorBox'),
            micDistanceSlider: document.getElementById('micDistanceSlider'),
            micDistanceValue: document.getElementById('micDistanceValue'),
            methodButtons: document.querySelectorAll('.method-btn'),
            inputMeter: document.getElementById('inputMeter'),
            outputMeter: document.getElementById('outputMeter'),
            inputLevel: document.getElementById('inputLevel'),
            outputLevel: document.getElementById('outputLevel'),
            parameterSection: document.getElementById('parameterSection'),
            parameterControls: document.getElementById('parameterControls'),
            outputDeviceSelect: document.getElementById('outputDeviceSelect'),
            sinkIdStatus: document.getElementById('sinkIdStatus')
        };

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        UI.startBtn.addEventListener('click', startMicrophone);
        UI.stopBtn.addEventListener('click', stopMicrophone);
        UI.micDistanceSlider.addEventListener('input', updateMicDistance);
        UI.methodButtons.forEach(btn => {
            btn.addEventListener('click', (e) => selectMethod(e.target.closest('button')));
        });
        UI.outputDeviceSelect.addEventListener('change', changeOutputDevice);

        function updateStatus(text, isActive = false) {
            UI.statusText.textContent = text;
            UI.statusIndicator.classList.toggle('active', isActive);
        }

        function showError(message) {
            UI.errorBox.textContent = message;
            UI.errorBox.style.display = 'block';
            setTimeout(() => {
                UI.errorBox.style.display = 'none';
            }, 5000);
        }

        async function startMicrophone() {
            console.log('startMicrophone called');
            try {
                updateStatus('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¦æ±‚ä¸­...', false);
                console.log('updateStatus done');

                // AudioContextåˆæœŸåŒ–
                if (!audioContext) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('AudioContext created');
                }

                // ãƒã‚¤ã‚¯å–å¾—ï¼ˆã‚¹ãƒ†ãƒ¬ã‚ªï¼‰
                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 2,
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    }
                });
                console.log('getUserMedia success');

                // AudioWorkletç™»éŒ²ï¼ˆUTF-8å¯¾å¿œã®Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
                const encoder = new TextEncoder();
                const encoded = encoder.encode(processorCode);
                const binaryString = String.fromCharCode(...encoded);
                const base64 = btoa(binaryString);
                const dataUrl = `data:application/javascript;base64,${base64}`;
                console.log('AudioWorklet loading...');
                await audioContext.audioWorklet.addModule(dataUrl);
                console.log('AudioWorklet loaded');

                // ã‚½ãƒ¼ã‚¹ãƒãƒ¼ãƒ‰ä½œæˆ
                sourceNode = audioContext.createMediaStreamSource(mediaStream);

                // AudioWorkletãƒ—ãƒ­ã‚»ãƒƒã‚µä½œæˆ
                processor = new AudioWorkletNode(audioContext, 'beamforming-processor');
                processor.port.onmessage = (event) => {
                    // ãƒ—ãƒ­ã‚»ãƒƒã‚µã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
                };

                // ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ä½œæˆï¼ˆãƒ¡ãƒ¼ã‚¿ãƒ¼ç”¨ï¼‰
                analyzerInput = audioContext.createAnalyser();
                analyzerInput.fftSize = 2048;
                analyzerOutput = audioContext.createAnalyser();
                analyzerOutput.fftSize = 2048;

                // ãƒãƒ¼ãƒ‰æ¥ç¶š
                sourceNode.connect(analyzerInput);
                sourceNode.connect(processor);
                processor.connect(analyzerOutput);
                analyzerOutput.connect(audioContext.destination);
                console.log('Nodes connected');

                // å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                try {
                    await enumerateOutputDevices();
                    console.log('enumerateOutputDevices completed');
                } catch (devError) {
                    console.error('Device enumeration error:', devError);
                    UI.sinkIdStatus.textContent = 'âš ï¸ ãƒ‡ãƒã‚¤ã‚¹åˆ—æŒ™å¤±æ•—ï¼ˆHTTPS/localhost ãŒå¿…è¦ï¼‰';
                }

                updateStatus('ãƒã‚¤ã‚¯å‡¦ç†ä¸­...', true);
                UI.startBtn.disabled = true;
                UI.stopBtn.disabled = false;
                UI.micDistanceSlider.disabled = false;

                // ãƒ¡ãƒ¼ã‚¿ãƒ¼æ›´æ–°ãƒ«ãƒ¼ãƒ—
                updateMeters();
                console.log('startMicrophone completed successfully');

            } catch (error) {
                console.error('ãƒã‚¤ã‚¯èµ·å‹•ã‚¨ãƒ©ãƒ¼:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                updateStatus('ã‚¨ãƒ©ãƒ¼', false);
                showError(`ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function stopMicrophone() {
            if (mediaStream) {
                mediaStream.getTracks().forEach(track => track.stop());
                mediaStream = null;
            }

            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close();
                audioContext = null;
            }

            sourceNode = null;
            processor = null;

            updateStatus('åœæ­¢', false);
            UI.startBtn.disabled = false;
            UI.stopBtn.disabled = true;
            UI.micDistanceSlider.disabled = true;
            UI.inputMeter.style.width = '0%';
            UI.outputMeter.style.width = '0%';
        }

        function updateMicDistance() {
            const value = parseInt(UI.micDistanceSlider.value);
            const meters = value / 100; // cmã‚’ãƒ¡ãƒ¼ãƒˆãƒ«ã«å¤‰æ›
            UI.micDistanceValue.textContent = `${value} cm`;

            if (processor) {
                processor.port.postMessage({
                    command: 'setMicDistance',
                    value: meters
                });
            }
        }

        function selectMethod(btn) {
            // å‰ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            UI.methodButtons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            const methodMap = {
                'methodPassthrough': 'passthrough',
                'methodMidside': 'midside',
                'methodParacardioid': 'paracardioid',
                'methodTDOA': 'tdoa',
                'methodFrequency': 'frequency'
            };

            const method = methodMap[btn.id];

            if (processor) {
                processor.port.postMessage({
                    command: 'setMethod',
                    value: method
                });
            }

            updateParameterControls(method);
        }

        function updateParameterControls(method) {
            const controls = UI.parameterControls;
            controls.innerHTML = '';

            const methodParams = {
                'midside': [
                    { name: 'midSideStrength', label: 'Sideæ¸›è¡°å¼·åº¦', min: 0, max: 1, step: 0.1, default: 0.7 }
                ],
                'paracardioid': [
                    { name: 'paracardioidStrength', label: 'æŒ‡å‘æ€§å¼·åº¦', min: 0, max: 1, step: 0.1, default: 0.8 }
                ],
                'tdoa': [
                    { name: 'tdoaDelay', label: 'é…å»¶èª¿æ•´', min: 0, max: 1, step: 0.1, default: 0.5 }
                ],
                'frequency': [
                    { name: 'frequencyBands', label: 'ãƒãƒ³ãƒ‰æ•°', min: 2, max: 8, step: 1, default: 4 }
                ]
            };

            const params = methodParams[method] || [];

            if (params.length > 0) {
                UI.parameterSection.style.display = 'block';
                params.forEach(param => {
                    const container = document.createElement('div');
                    container.className = 'slider-container';
                    container.innerHTML = `
                        <label class="slider-label">${param.label}</label>
                        <input type="range" min="${param.min}" max="${param.max}" step="${param.step}" value="${param.default}" class="param-slider" data-param="${param.name}">
                        <span class="slider-value">${param.default.toFixed(1)}</span>
                    `;
                    controls.appendChild(container);

                    const slider = container.querySelector('.param-slider');
                    const value = container.querySelector('.slider-value');

                    slider.addEventListener('input', (e) => {
                        const val = parseFloat(e.target.value);
                        value.textContent = val.toFixed(1);

                        if (processor) {
                            processor.port.postMessage({
                                command: `set${param.name.charAt(0).toUpperCase() + param.name.slice(1)}`,
                                value: val
                            });
                        }
                    });
                });
            } else {
                UI.parameterSection.style.display = 'none';
            }
        }

        async function enumerateOutputDevices() {
            console.log("enumerateOutputDevices start");
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                    console.error('navigator.mediaDevices ã¯åˆ©ç”¨ä¸å¯');
                    UI.sinkIdStatus.textContent = 'âš ï¸ å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹é¸æŠã¯ HTTPS/localhost ã§ã®ã¿åˆ©ç”¨å¯èƒ½';
                    return;
                }
                
                const devices = await navigator.mediaDevices.enumerateDevices();
                console.log('Devices:', devices);
                const audioOutputs = devices.filter(device => device.kind === 'audiooutput');
                console.log('Audio outputs:', audioOutputs);
                UI.outputDeviceSelect.innerHTML = '<option value="">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</option>';
                audioOutputs.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `Audio Output ${device.deviceId.substring(0, 5)}...`;
                    UI.outputDeviceSelect.appendChild(option);
                });

                if (audioOutputs.length > 0) {
                    UI.sinkIdStatus.textContent = `âœ“ ${audioOutputs.length} å€‹ã®ãƒ‡ãƒã‚¤ã‚¹ãŒåˆ©ç”¨å¯èƒ½`;
                } else {
                    UI.sinkIdStatus.textContent = 'â„¹ï¸ å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                }
            } catch (error) {
                console.error('Error enumerating devices:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                
                // file:// ãƒ—ãƒ­ãƒˆã‚³ãƒ«ã§ã® SecurityError
                if (error.name === 'SecurityError') {
                    UI.sinkIdStatus.textContent = 'âš ï¸ HTTPS ã¾ãŸã¯ localhost ã§ã”åˆ©ç”¨ãã ã•ã„';
                } else {
                    UI.sinkIdStatus.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                }
            }
        }

        async function changeOutputDevice() {
            if (!audioContext) return;

            const deviceId = UI.outputDeviceSelect.value;
            
            try {
                if (typeof audioContext.setSinkId !== 'function') {
                    UI.sinkIdStatus.textContent = 'âš ï¸ setSinkId() ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼ˆHTTPS ã¾ãŸã¯ localhost ãŒå¿…è¦ã§ã™ï¼‰';
                    return;
                }

                await audioContext.setSinkId(deviceId);
                const displayName = deviceId === '' ? 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ' : UI.outputDeviceSelect.options[UI.outputDeviceSelect.selectedIndex].text;
                UI.sinkIdStatus.textContent = `âœ“ å‡ºåŠ›ãƒ‡ãƒã‚¤ã‚¹: ${displayName}`;
            } catch (error) {
                console.error('Error setting sink ID:', error);
                UI.sinkIdStatus.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                UI.outputDeviceSelect.value = '';
            }
        }

        function updateMeters() {
            if (!analyzerInput || !analyzerOutput) {
                requestAnimationFrame(updateMeters);
                return;
            }

            // å…¥åŠ›ãƒ¬ãƒ™ãƒ«è¨ˆç®—
            const inputData = new Uint8Array(analyzerInput.frequencyBinCount);
            analyzerInput.getByteFrequencyData(inputData);
            const inputAvg = inputData.reduce((a, b) => a + b) / inputData.length;
            const inputPercent = (inputAvg / 255) * 100;
            const inputDB = 20 * Math.log10(inputAvg / 255 || 0.001);

            UI.inputMeter.style.width = Math.min(inputPercent, 100) + '%';
            UI.inputLevel.textContent = inputDB.toFixed(1) + ' dB';

            // å‡ºåŠ›ãƒ¬ãƒ™ãƒ«è¨ˆç®—
            const outputData = new Uint8Array(analyzerOutput.frequencyBinCount);
            analyzerOutput.getByteFrequencyData(outputData);
            const outputAvg = outputData.reduce((a, b) => a + b) / outputData.length;
            const outputPercent = (outputAvg / 255) * 100;
            const outputDB = 20 * Math.log10(outputAvg / 255 || 0.001);

            UI.outputMeter.style.width = Math.min(outputPercent, 100) + '%';
            UI.outputLevel.textContent = outputDB.toFixed(1) + ' dB';

            requestAnimationFrame(updateMeters);
        }

        // åˆæœŸåŒ–
        updateStatus('å¾…æ©Ÿä¸­', false);
        UI.micDistanceSlider.disabled = true;
    </script>
</body>
</html>
