# ステレオマイク指向性強化 - ビームフォーミングアプリ

## 概要

このアプリケーションは、Web Audio APIを使用してステレオマイクの指向性を強化し、周囲の話し声を抑制するツールです。4つの異なるビームフォーミング技法を実装しており、用途に応じて切り替えられます。

## 実装された処理方法

### 1. **Mid/Side ミックス法**
- **原理**: ステレオ信号を Mid (L+R, 中央成分) と Side (L-R, 側面成分) に分解
- **効果**: Side 成分を減衰させることで、周囲の音を抑制し正面の音を強調
- **パラメータ**: Side 減衰強度 (0-1)
- **用途**: 最も単純で CPU 負荷が低い方法

### 2. **パラカーディオイド (Paracardioid)**
- **原理**: 複数の指向性パターン（全指向性・双指向性・単一指向性）を加重合成
- **効果**: 指向性パターンを調整することで正面方向の感度を段階的に上げる
- **パラメータ**: 指向性強度 (0-1)
- **用途**: 滑らかな指向性制御が必要な場合

### 3. **TDOA (Time Difference of Arrival) ビームフォーミング**
- **原理**: 左右のチャンネルに時間差を付与して、特定の方向から来た音を強調
- **効果**: マイク間隔と音速から計算した遅延を適用し、指向性を持たせる
- **パラメータ**: マイク間隔 (5-50cm)
- **用途**: マイク配置が既知の場合に最適

### 4. **周波数依存ビームフォーミング**
- **原理**: 低周波と高周波で異なるビームフォーミングパターンを適用
- **効果**: 低周波（ビームフォーミングが困難）は全指向性、高周波は指向性パターンを適用
- **パラメータ**: バンド数 (2-8)
- **用途**: 周波数帯域ごとに最適な処理を行いたい場合

## ファイル構成

```
/tmp/stereo-beamforming/
├── index.html                    # メインUI（ブラウザで実行）
├── beamforming-processor.js      # AudioWorklet プロセッサ（実際の処理）
└── README.md                     # このファイル
```

## 使用手順

### 1. サーバー起動

```bash
cd /tmp/stereo-beamforming
python3 -m http.server 8000
```

### 2. ブラウザで開く

Chrome または Edge で以下にアクセス:
```
http://localhost:8000
```

### 3. マイクへのアクセス許可

ブラウザがマイクへのアクセスを要求するので、許可してください。

### 4. 処理方法を選択

UIから以下を操作:
- **マイクを開始** ボタンをクリック
- 4つの処理方法から選択
- **マイク間隔** スライダーで間隔を調整（20cm推奨）

### 5. 仮想ケーブルに接続（オプション）

macOS の場合、出力を仮想ケーブルに流す方法:

```bash
# BlackHole など仮想オーディオデバイスをインストール
# Homebrew の場合:
brew install blackhole-2ch

# または SoundFlower（古い）
```

Chrome の音声出力をシステムオーディオデバイスから仮想ケーブルに再ルーティングする方法：
- Chrome の設定 > サウンド から出力デバイスを変更
- OBS Studio や Zoom などで仮想ケーブルを入力デバイスとして設定

## パラメータ調整ガイド

### マイク間隔
- **典型値**: 15-25cm
- **小さい値** (5-10cm): 弱い指向性
- **大きい値** (30-50cm): 強い指向性（計算複雑性も増加）

### Side 減衰強度（Mid/Side）
- **0.0**: パススルー（処理なし）
- **0.5**: 中程度の抑制
- **1.0**: 最大の抑制（音声が変わる可能性）

### 指向性強度（パラカーディオイド）
- **0.0**: 全指向性（感度が均等）
- **0.5**: 中程度のカーディオイド
- **1.0**: 最大カーディオイド（正面のみ）

## 技術仕様

### 使用技術
- **Web Audio API**: リアルタイム音声処理
- **AudioWorklet**: メインスレッドをブロックしない信号処理
- **getUserMedia**: ステレオマイク入力キャプチャ

### 音声フロー
```
Mic Input (Stereo)
    ↓
Analyzer (Input Level)
    ↓
AudioWorklet Processor
  ├─ Method Selection
  ├─ Beamforming Algorithm
  └─ Mic Distance Parameter
    ↓
Analyzer (Output Level)
    ↓
System Audio Output
```

### サンプリングレート
- デフォルト: 48 kHz（ブラウザの標準）
- 自動検出: AudioContext が環境に応じて設定

### バッファサイズ
- AudioWorklet: 128 サンプル（デフォルト）
- Analyzer: 2048 FFT（メーター用）

## ブラウザ互換性

| ブラウザ | 対応状況 |
|--------|--------|
| Chrome | ✅ 完全対応 |
| Edge   | ✅ 完全対応 |
| Firefox | ✅ 対応 (AudioWorklet) |
| Safari | ⚠️ 制限あり (AudioWorklet 非対応) |

## 既知の制限事項

1. **AudioWorklet の遅延**: 数フレーム（数〜数十ミリ秒）の遅延が発生
2. **シングルマイク制限**: 現在の実装では、マイク間隔パラメータでシミュレーション
3. **周波数依存処理**: 簡易実装（フルバンドスプリッターではなく加重合成）
4. **リアルタイム制約**: CPU 負荷が高い場合、音声が途切れる可能性

## トラブルシューティング

### マイクが認識されない
- ブラウザの権限設定を確認
- `chrome://settings/content/microphone` で許可を確認
- macOS の場合、システム設定 > セキュリティとプライバシー > マイク

### 音が出ない
- システムボリュームを確認
- ブラウザのボリュームを確認
- 別のタブで音声出力をテスト

### CPU 使用率が高い
- 別のアプリケーションを終了
- ブラウザの拡張機能を無効化
- Tab を再読み込み

### AudioWorklet エラー
- Chrome DevTools コンソールでエラーを確認
- ブラウザのバージョンを更新

## 応用例

### テレビ会議での使用
1. Chrome で本アプリを開く
2. マイク間隔を PC の値に合わせて調整
3. 処理方法として「パラカーディオイド」を選択
4. 仮想ケーブルを Zoom/Teams の入力デバイスに設定

### ライブ配信
1. OBS Studio を起動
2. 仮想ケーブルを音声入力として設定
3. 処理方法を「周波数依存」に変更
4. 帯域数を 4-6 に調整

### デバッグ・テスト
1. 各処理方法で「入力レベル」「出力レベル」メーターを比較
2. 異なるマイク間隔での指向性の変化を観察
3. 処理前後の音質差をモニタリング

## パフォーマンス最適化のヒント

### CPU 負荷を削減
- Mid/Side を優先的に使用（最も軽量）
- TDOA の遅延バッファサイズを削減
- アナライザーの FFT サイズを 1024 に削減

### 遅延を最小化
- AudioWorklet の latency hint を "interactive" に設定
- 不要な Analyzer を削除
- バッファサイズを 64 に削減（ただし不安定性増加）

## API リファレンス（AudioWorklet）

### メッセージポート

#### 送信コマンド（メインスレッド → Processor）

```javascript
// 処理方法を変更
processor.port.postMessage({
  command: 'setMethod',
  value: 'midside' | 'paracardioid' | 'tdoa' | 'frequency'
});

// マイク間隔を変定（メートル単位）
processor.port.postMessage({
  command: 'setMicDistance',
  value: 0.2  // 20cm
});

// Mid/Side 強度を調整
processor.port.postMessage({
  command: 'setMidSideStrength',
  value: 0.7  // 0-1
});

// パラカーディオイド強度を調整
processor.port.postMessage({
  command: 'setParacardioidStrength',
  value: 0.8  // 0-1
});
```

## ライセンス

このコードは自由に使用・改変・配布できます。

## 今後の改善予定

- [ ] フルバンドスプリッターの実装（周波数依存処理の改善）
- [ ] 複数マイク対応（3個以上）
- [ ] 機械学習による自動マイク間隔検出
- [ ] 周囲の音声パターン学習・適応ビームフォーミング
- [ ] WASM による CPU 集約的処理の高速化
- [ ] 出力をリアルタイムで WAV/MP3 録音
